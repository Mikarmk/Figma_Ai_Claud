# Устранение проблем с Figma плагином

## Исправленная ошибка: "figma.fetch is not a function"

### Проблема
Ошибка возникала из-за того, что функция `figma.fetch` недоступна в API версии 1.0.0 Figma плагинов.

### Решение
Мы переработали архитектуру плагина:

1. **Перенесли сетевые запросы в UI-часть** - теперь HTTP-запросы выполняются в `ui.html`, где доступен стандартный `fetch`
2. **Изменили коммуникацию между частями плагина** - UI отправляет результаты API-запросов в основной код через `postMessage`
3. **Обновили настройки сети в манифесте** - добавили разрешение для `localhost:3000`

### Архитектура после исправления

```
UI (ui.html)
├── Получает сообщение пользователя
├── Выполняет fetch запрос к localhost:3000/api/figma-chat
├── Отправляет результат в основной код
└── Отображает ответ пользователю

Основной код (code.js)
├── Получает результат API-запроса от UI
├── Обрабатывает команды вставки текста
└── Управляет элементами Figma
```

## Файлы, которые были изменены

### 1. `manifest.json`
- Обновлен `networkAccess` для разрешения запросов к localhost

### 2. `code.js`
- Удален `figma.fetch`
- Добавлена обработка сообщений типа `api-response` от UI

### 3. `ui.html`
- Функция `sendMessage()` теперь выполняет HTTP-запросы
- Добавлена обработка ошибок сети
- Результаты отправляются в основной код через `postMessage`

## Проверка работы

1. Убедитесь, что сервер запущен: `npm start`
2. Загрузите плагин в Figma
3. Откройте плагин и отправьте сообщение
4. Проверьте консоль браузера на наличие ошибок

## Возможные проблемы

### Ошибка CORS
Если возникают ошибки CORS, убедитесь, что сервер настроен с правильными заголовками (уже настроено в `server.js`).

### Сервер недоступен
Убедитесь, что:
- Сервер запущен на порту 3000
- В `.env` файле указан правильный API ключ
- Нет блокировки файрвола

### API ключ
Проверьте, что в `.env` файле указан действующий API ключ Anthropic.